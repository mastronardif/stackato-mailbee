<html><head><title>Perl::Critic::TestUtils</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.012001 at Wed Apr 13 00:04:30 2011 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#INTERFACE_SUPPORT'>INTERFACE SUPPORT</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#EXPORTS'>EXPORTS</a>
  <li class='indexItem indexItem1'><a href='#.run_file_information'>.run file information</a>
  <li class='indexItem indexItem1'><a href='#BUGS_AND_CAVEATS_AND_TODO_ITEMS'>BUGS AND CAVEATS AND TODO ITEMS</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT'>COPYRIGHT</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Perl::Critic::TestUtils - Utility functions for testing new Policies.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="INTERFACE_SUPPORT"
>INTERFACE SUPPORT</a></h1>

<p>This is considered to be a public module.
Any changes to its interface will go through a deprecation cycle.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    use Perl::Critic::TestUtils qw(critique pcritique fcritique);

    my $code = &#39;&#60;&#60;END_CODE&#39;;
    package Foo::Bar;
    $foo = frobulator();
    $baz = $foo ** 2;
    1;
    END_CODE

    # Critique code against all loaded policies...
    my $perl_critic_config = { -severity =&#62; 2 };
    my $violation_count = critique( \$code, $perl_critic_config);

    # Critique code against one policy...
    my $custom_policy = &#39;Miscellanea::ProhibitFrobulation&#39;
    my $violation_count = pcritique( $custom_policy, \$code );

    # Critique code against one filename-related policy...
    my $custom_policy = &#39;Modules::RequireFilenameMatchesPackage&#39;
    my $violation_count = fcritique( $custom_policy, \$code, &#39;Foo/Bar.pm&#39; );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module is used by <a href="../../Perl/Critic.html" class="podlinkpod"
>Perl::Critic</a> only for self-testing. It provides a few handy subroutines for testing new Perl::Critic::Policy modules. Look at the test programs that ship with Perl::Critic for more examples of how to use these subroutines.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXPORTS"
>EXPORTS</a></h1>

<dl>
<dt><a name="block_perlcriticrc()"
>block_perlcriticrc()</a></dt>

<dd>
<p>If a user has a <em>~/.perlcriticrc</em> file, this can interfere with testing. This handy method disables the search for that file -- simply call it at the top of your <em>.t</em> program. Note that this is not easily reversible, but that should not matter.</p>

<dt><a name="critique_with_violations(_$code_string_ref,_$config_ref_)"
>critique_with_violations( $code_string_ref, $config_ref )</a></dt>

<dd>
<p>Test a block of code against the specified Perl::Critic::Config instance (or <code>undef</code> for the default). Returns the violations that occurred.</p>

<dt><a name="critique(_$code_string_ref,_$config_ref_)"
>critique( $code_string_ref, $config_ref )</a></dt>

<dd>
<p>Test a block of code against the specified Perl::Critic::Config instance (or <code>undef</code> for the default). Returns the number of violations that occurred.</p>

<dt><a name="pcritique_with_violations(_$policy_name,_$code_string_ref,_$config_ref_)"
>pcritique_with_violations( $policy_name, $code_string_ref, $config_ref )</a></dt>

<dd>
<p>Like <code>critique_with_violations()</code>, but tests only a single policy instead of the whole bunch.</p>

<dt><a name="pcritique(_$policy_name,_$code_string_ref,_$config_ref_)"
>pcritique( $policy_name, $code_string_ref, $config_ref )</a></dt>

<dd>
<p>Like <code>critique()</code>, but tests only a single policy instead of the whole bunch.</p>

<dt><a name="fcritique_with_violations(_$policy_name,_$code_string_ref,_$filename,_$config_ref_)"
>fcritique_with_violations( $policy_name, $code_string_ref, $filename, $config_ref )</a></dt>

<dd>
<p>Like <code>pcritique_with_violations()</code>, but pretends that the code was loaded from the specified filename. This is handy for testing policies like <code>Modules::RequireFilenameMatchesPackage</code> which care about the filename that the source derived from.</p>

<p>The <code>$filename</code> parameter must be a relative path, not absolute. The file and all necessary subdirectories will be created via <a href="../../File/Temp.html" class="podlinkpod"
>File::Temp</a> and will be automatically deleted.</p>

<dt><a name="fcritique(_$policy_name,_$code_string_ref,_$filename,_$config_ref_)"
>fcritique( $policy_name, $code_string_ref, $filename, $config_ref )</a></dt>

<dd>
<p>Like <code>pcritique()</code>, but pretends that the code was loaded from the specified filename. This is handy for testing policies like <code>Modules::RequireFilenameMatchesPackage</code> which care about the filename that the source derived from.</p>

<p>The <code>$filename</code> parameter must be a relative path, not absolute. The file and all necessary subdirectories will be created via <a href="../../File/Temp.html" class="podlinkpod"
>File::Temp</a> and will be automatically deleted.</p>

<dt><a name="subtests_in_tree(_$dir_)"
>subtests_in_tree( $dir )</a></dt>

<dd>
<p>Searches the specified directory recursively for <em>.run</em> files. Each one found is parsed and a hash-of-list-of-hashes is returned. The outer hash is keyed on policy short name, like <code>Modules::RequireEndWithOne</code>. The inner hash specifies a single test to be handed to <code>pcritique()</code> or <code>fcritique()</code>, including the code string, test name, etc. See below for the syntax of the <em>.run</em> files.</p>

<dt><a name="should_skip_author_tests()"
>should_skip_author_tests()</a></dt>

<dd>
<p>Answers whether author tests should run.</p>

<dt><a name="get_author_test_skip_message()"
>get_author_test_skip_message()</a></dt>

<dd>
<p>Returns a string containing the message that should be emitted when a test is skipped due to it being an author test when author tests are not enabled.</p>

<dt><a name="starting_points_including_examples()"
>starting_points_including_examples()</a></dt>

<dd>
<p>Returns a list of the directories contain code that needs to be tested when it is desired that the examples be included.</p>

<dt><a name="bundled_policy_names()"
>bundled_policy_names()</a></dt>

<dd>
<p>Returns a list of Policy packages that come bundled with this package. This functions by searching <em>MANIFEST</em> for <em>lib/Perl/Critic/Policy/*.pm</em> and converts the results to package names.</p>

<dt><a name="names_of_policies_willing_to_work(_%configuration_)"
>names_of_policies_willing_to_work( %configuration )</a></dt>

<dd>
<p>Returns a list of the packages of policies that are willing to function on the current system using the specified configuration.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name=".run_file_information"
><em>.run</em> file information</a></h1>

<p>Testing a policy follows a very simple pattern:</p>

<pre>    * Policy name
        * Subtest name
        * Optional parameters
        * Number of failures expected
        * Optional exception expected
        * Optional filename for code</pre>

<p>Each of the subtests for a policy is collected in a single <em>.run</em> file, with test properties as comments in front of each code block that describes how we expect Perl::Critic to react to the code. For example, say you have a policy called Variables::ProhibitVowels:</p>

<pre>    (In file t/Variables/ProhibitVowels.run)

    ## name Basics
    ## failures 1
    ## cut

    my $vrbl_nm = &#39;foo&#39;;    # Good, vowel-free name
    my $wango = 12;         # Bad, pronouncable name


    ## name Sometimes Y
    ## failures 1
    ## cut

    my $yllw = 0;       # &#34;y&#34; not a vowel here
    my $rhythm = 12;    # But here it is</pre>

<p>These are called &#34;subtests&#34;, and two are shown above. The beauty of incorporating multiple subtests in a file is that the <em>.run</em> is itself a (mostly) valid Perl file, and not hidden in a HEREDOC, so your editor&#39;s color-coding still works, and it is much easier to work with the code and the POD.</p>

<p>If you need to pass any configuration parameters for your subtest, do so like this:</p>

<pre>    ## parms { allow_y =&#62; &#39;0&#39; }</pre>

<p>Note that all the values in this hash must be strings because that&#39;s what Perl::Critic will hand you from a <em>.perlcriticrc</em>.</p>

<p>If it&#39;s a TODO subtest (probably because of some weird corner of PPI that we exercised that Adam is getting around to fixing, right?), then make a <code>##TODO</code> entry.</p>

<pre>    ## TODO Should pass when PPI 1.xxx comes out</pre>

<p>If the code is expected to trigger an exception in the policy, indicate that like so:</p>

<pre>    ## error 1</pre>

<p>If you want to test the error message, mark it with <code>/.../</code> to indicate a <code>like()</code> test:</p>

<pre>    ## error /Can&#39;t load Foo::Bar/</pre>

<p>If the policy you are testing cares about the filename of the code, you can indicate that <code>fcritique</code> should be used like so (see <code>fcritique</code> for more details):</p>

<pre>    ## filename lib/Foo/Bar.pm</pre>

<p>The value of <code>parms</code> will get <code>eval</code>ed and passed to <code>pcritique()</code>, so be careful.</p>

<p>In general, a subtest document runs from the <code>## cut</code> that starts it to either the next <code>## name</code> or the end of the file. In very rare circumstances you may need to end the test document earlier. A second <code>## cut</code> will do this. The only known need for this is in <em>t/Miscellanea/RequireRcsKeywords.run</em>, where it is used to prevent the RCS keywords in the file footer from producing false positives or negatives in the last test.</p>

<p>Note that nowhere within the <em>.run</em> file itself do you specify the policy that you&#39;re testing. That&#39;s implicit within the filename.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="BUGS_AND_CAVEATS_AND_TODO_ITEMS"
>BUGS AND CAVEATS AND TODO ITEMS</a></h1>

<p>Test that we have a t/*/*.run for each lib/*/*.pm</p>

<p>Allow us to specify the nature of the failures, and which one. If there are 15 lines of code, and six of them fail, how do we know they&#39;re the right six?</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Chris Dolan &#60;cdolan@cpan.org&#62; and the rest of the <a href="../../Perl/Critic.html" class="podlinkpod"
>Perl::Critic</a> team.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT"
>COPYRIGHT</a></h1>

<p>Copyright (c) 2005-2011 Chris Dolan.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself. The full text of this license can be found in the LICENSE file included with this module.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
